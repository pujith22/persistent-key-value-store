# to migrate database schema, you may use the following commands

psql -U pujith22 -d kvstore -f ./sql/init_kv.sql


# Build & run instructions

## Quick test builds (no PostgreSQL client required)
# The test harnesses provide a fake persistence provider so you can build and
# run unit/integration tests without libpq or a running PostgreSQL server.

g++ -std=c++17 test/test_server.cpp server.cpp test/persistence_adapter_stub.cpp \
	-I include -I third_party -lpthread -o test_server.out
./test_server.out

g++ -std=c++17 test/test_metrics.cpp server.cpp test/persistence_adapter_stub.cpp \
	-I include -I third_party -lpthread -o test_metrics.out
./test_metrics.out

## Full production build (requires libpq and PostgreSQL headers/libraries)
# On systems with pg_config available, you can use it to locate the include/lib dirs:
INC=$(pg_config --includedir)
LIB=$(pg_config --libdir)

# If you have the nlohmann json installed system-wide, prefer that; otherwise the vendored header
# is under third_party/nlohmann/json.hpp
JSON_INC_VENDOR=./third_party

# Option A: set PG_CONNINFO in your shell (convenient for quick testing)
# export PG_CONNINFO='dbname=kvstore user=you password=... host=127.0.0.1 port=5432'
# Option B: write a `config/db.json` with { "conninfo": "..." }

g++ -std=c++17 server.cpp main_server.cpp persistence_adapter.cpp \
	-I include -I third_party -I"$(pg_config --includedir)" -L"$(pg_config --libdir)" -lpq -o kv_server.out

# Run the server (example):
./kv_server.out --json-logs --policy=lru

# Useful runtime flags
# --no-preload or --skip-preload    : skip synchronous preload of keys 1..1000 on startup
# --policy=lru|fifo|random          : cache eviction policy
# --json-logs                       : structured JSON request/response logs

# Observability endpoints
# GET /health  -> {"status":"ok","uptime_ms":...}
# GET /metrics -> returns JSON with cache stats, persistence pool metrics, system metrics (cpu/mem/disk/net) and process metrics

# Helper scripts
# scripts/insert_random_kv.sh : populate DB with test keys (uses PG_CONNINFO or config/db.json)
# scripts/poll_metrics.sh    : simple jq-based poller that prints per-interval summary (requires jq)