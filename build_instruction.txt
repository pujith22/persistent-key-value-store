# to migrate database schema, you may use the following commands

psql -U pujith22 -d kvstore -f ./sql/init_kv.sql


# for compiling and running the persistence layer in the test folder, you can run the following commands

# 1) Install dependencies (macOS/Homebrew):
#    brew install postgresql nlohmann-json
#    # If PostgreSQL client is already installed, you only need: brew install nlohmann-json

INC=$(pg_config --includedir)
LIB=$(pg_config --libdir)
# Prefer vendored header if present
JSON_INC_VENDOR=./third_party
JSON_INC_SYS=$(brew --prefix nlohmann-json 2>/dev/null)/include

# Option A: set connection via environment for this shell
# source scripts/setup_pg_env.zsh

# Option B: define conninfo in config/db.json
# {
#   "conninfo": "dbname=kvstore user=youruser host=127.0.0.1 port=5432 password=yourpass"
# }

if [ -f ./third_party/nlohmann/json.hpp ]; then
	g++ -std=c++17 ./test/test_persistence.cpp persistence_adapter.cpp -I"$INC" -I"$JSON_INC_VENDOR" -I./include -L"$LIB" -lpq -o test_persistence.out
else
	g++ -std=c++17 ./test/test_persistence.cpp persistence_adapter.cpp -I"$INC" -I"$JSON_INC_SYS" -I./include -L"$LIB" -lpq -o test_persistence.out
fi

# Run tests (uses PG_CONNINFO if set; otherwise reads config/db.json; fallback dbname=kvstore)
./test_persistence.out