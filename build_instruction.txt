# to migrate database schema, you may use the following commands

psql -U pujith22 -d kvstore -f ./sql/init_kv.sql


# for compiling and running the persistence layer in the test folder, you can run the following commands

# 1) Install dependencies (macOS/Homebrew):
#    brew install postgresql nlohmann-json
#    # If PostgreSQL client is already installed, you only need: brew install nlohmann-json

INC=$(pg_config --includedir)
LIB=$(pg_config --libdir)
# Prefer vendored header if present
JSON_INC_VENDOR=./third_party
JSON_INC_SYS=$(brew --prefix nlohmann-json 2>/dev/null)/include

# Option A: set connection via environment for this shell
# source scripts/setup_pg_env.zsh

# Option B: define conninfo in config/db.json
# {
#   "conninfo": "dbname=kvstore user=youruser host=127.0.0.1 port=5432 password=yourpass"
# }

if [ -f ./third_party/nlohmann/json.hpp ]; then
	g++ -std=c++17 ./test/test_persistence.cpp persistence_adapter.cpp -I"$INC" -I"$JSON_INC_VENDOR" -I./include -L"$LIB" -lpq -o test_persistence.out
else
	g++ -std=c++17 ./test/test_persistence.cpp persistence_adapter.cpp -I"$INC" -I"$JSON_INC_SYS" -I./include -L"$LIB" -lpq -o test_persistence.out
fi

# Run tests (uses PG_CONNINFO if set; otherwise reads config/db.json; fallback dbname=kvstore)
./test_persistence.out


## to run production kv_server / test_server, you can run following commands.
g++ -std=c++17 server.cpp main_server.cpp -I include -I third_party -o kv_server.out
g++ -std=c++17 test/test_server.cpp server.cpp -I include -I third_party -o test_server.out


## to run the executable, you may opt for the following structure
./kv_server.out or ./test_server.out

# optional cache policy:
# ./kv_server.out --policy=lru
# ./kv_server.out --policy=fifo
# ./kv_server.out --policy=random

# enable structured JSON logging for observability:
# ./kv_server.out --json-logs

#  New endpoints for observability endpoints:
#   GET /health   -> {"status":"ok","uptime_ms":...}
#   GET /metrics  -> {"entries":n,"hits":n,"misses":n,"evictions":n}
#  Updated Entry points output:
#   GET /        -> JSON service catalog listing all routes
#   GET /home    -> Styled HTML homepage with quick-start details (we can edit assets/home.html to tweak layout)

# final build command for server with persistence library

g++ -std=c++17 server.cpp main_server.cpp persistence_adapter.cpp -I include -I third_party -I"$(pg_config --includedir)" -L"$(pg_config --libdir)" -lpq -o kv_server.out